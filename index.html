<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRISP Multi-Agent Clinical Reasoning Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #060810;
  --surface: #0c1020;
  --surface2: #131830;
  --surface3: #1a2040;
  --border: #1e2548;
  --text: #e4e8f7;
  --text-dim: #6d7599;
  --text-muted: #3a4168;
  --hoac: #4d8fff;
  --icf: #00e88f;
  --neuro: #ffd23f;
  --clini: #bf6dff;
  --bias: #ff7b3a;
  --lit: #ff5ca1;
  --accept: #00e88f;
  --reject: #ff4757;
  --partial: #ffd23f;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;line-height:1.6;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:0.4;}

.header{background:linear-gradient(180deg,#0a0e1a 0%,var(--bg) 100%);padding:1.5rem 2rem 1rem;border-bottom:1px solid var(--border);position:relative;}
.header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--hoac),var(--icf),var(--neuro),var(--clini),var(--bias),var(--lit),transparent);opacity:0.4;}
.header-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:1rem;}
.header h1{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;letter-spacing:-0.5px;background:linear-gradient(135deg,#fff 0%,#8ba4d0 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.patient-badge{display:flex;align-items:center;gap:0.75rem;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:0.5rem 1rem;}
.patient-badge .name{font-family:'Syne',sans-serif;font-weight:700;font-size:0.95rem;}
.patient-badge .detail{font-size:0.75rem;color:var(--text-dim);}
.stats-strip{display:flex;gap:0.4rem;margin-top:0.75rem;flex-wrap:wrap;}
.stat-chip{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:0.25rem 0.7rem;font-size:0.7rem;font-family:'JetBrains Mono',monospace;color:var(--text-dim);display:flex;align-items:center;gap:0.4rem;}
.stat-chip .val{color:var(--text);font-weight:600;}

.nav{display:flex;gap:0.25rem;padding:0 2rem;background:var(--surface);border-bottom:1px solid var(--border);}
.nav-btn{padding:0.7rem 1.2rem;font-family:'Syne',sans-serif;font-size:0.8rem;font-weight:600;color:var(--text-dim);background:none;border:none;cursor:pointer;position:relative;transition:color 0.3s;}
.nav-btn:hover{color:var(--text);}
.nav-btn.active{color:var(--text);}
.nav-btn.active::after{content:'';position:absolute;bottom:0;left:0.5rem;right:0.5rem;height:2px;background:var(--hoac);border-radius:1px;}

.content{max-width:1440px;margin:0 auto;padding:1.5rem 2rem;}
.panel{display:none;}
.panel.active{display:block;}

/* ===== NETWORK SPLIT LAYOUT ===== */
.network-split{display:grid;grid-template-columns:1fr 360px;gap:1rem;margin-bottom:1rem;}
.network-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
.network-header h2{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;}
.replay-controls{display:flex;gap:0.5rem;align-items:center;}
.replay-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:0.4rem 1rem;border-radius:8px;font-family:'Syne',sans-serif;font-size:0.75rem;font-weight:600;cursor:pointer;transition:all 0.3s;}
.replay-btn:hover{background:var(--hoac);border-color:var(--hoac);}
.replay-btn.playing{background:var(--reject);border-color:var(--reject);}
.speed-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);padding:0.3rem 0.6rem;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:0.7rem;cursor:pointer;transition:all 0.2s;}
.speed-btn.active{color:var(--text);border-color:var(--hoac);background:rgba(77,143,255,0.15);}

.network-svg-wrap{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;position:relative;}
.network-svg-wrap svg{width:100%;height:auto;display:block;}

/* Agent node states */
.agent-node{cursor:pointer;}
.agent-glow{animation:pulse 3s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:0.15;}50%{opacity:0.3;}}
.node-label{font-family:'Syne',sans-serif;font-weight:700;font-size:11px;fill:var(--text);text-anchor:middle;}
.node-role{font-family:'Plus Jakarta Sans',sans-serif;font-size:8px;fill:var(--text-dim);text-anchor:middle;}

.agent-node.speaking .agent-glow{animation:speakPulse 0.6s ease-in-out infinite;opacity:0.5;}
.agent-node.speaking circle:nth-child(2){stroke-width:3;}
@keyframes speakPulse{0%,100%{opacity:0.3;r:48;}50%{opacity:0.6;r:54;}}
.agent-node.challenged .agent-glow{animation:challengeFlash 0.4s ease-out;opacity:0.6;}
@keyframes challengeFlash{0%{opacity:0.8;r:56;}100%{opacity:0.3;r:48;}}
.agent-node.responding .agent-glow{animation:respondPulse 0.5s ease-in-out infinite;}
@keyframes respondPulse{0%,100%{opacity:0.3;}50%{opacity:0.55;}}
.agent-node.dimmed{opacity:0.25;transition:opacity 0.5s;}
.agent-node.active-agent{opacity:1;transition:opacity 0.3s;}

/* Connection paths */
.conn-path{fill:none;stroke-width:2;opacity:0.15;cursor:pointer;transition:opacity 0.4s,stroke-width 0.3s;}
.conn-path:hover,.conn-path.active{opacity:0.85;stroke-width:3;}
.conn-path.animated{stroke-dasharray:8 4;animation:flowDash 1.5s linear infinite;}
@keyframes flowDash{to{stroke-dashoffset:-24;}}
.conn-count{font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;fill:var(--bg);pointer-events:none;}
.conn-count-bg{pointer-events:none;}

/* Data pulse */
.data-pulse{filter:url(#glow);transition:r 0.2s;}

/* ===== CHAT TRANSCRIPT ===== */
.chat-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;display:flex;flex-direction:column;max-height:520px;overflow:hidden;}
.chat-header{padding:0.75rem 1rem;border-bottom:1px solid var(--border);font-family:'Syne',sans-serif;font-weight:700;font-size:0.85rem;display:flex;align-items:center;gap:0.5rem;flex-shrink:0;}
.chat-header .live-dot{width:8px;height:8px;border-radius:50%;background:var(--reject);animation:liveBlink 1.5s ease-in-out infinite;display:none;}
.chat-header .live-dot.on{display:block;}
@keyframes liveBlink{0%,100%{opacity:1;}50%{opacity:0.3;}}
.chat-body{flex:1;overflow-y:auto;padding:0.75rem;scroll-behavior:smooth;}
.chat-body::-webkit-scrollbar{width:3px;}
.chat-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.chat-empty{text-align:center;padding:3rem 1rem;color:var(--text-muted);font-size:0.8rem;}
.chat-empty p:first-child{font-size:1.5rem;margin-bottom:0.5rem;}

.chat-msg{margin-bottom:0.75rem;animation:msgSlideIn 0.4s ease-out;}
@keyframes msgSlideIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.chat-msg-header{display:flex;align-items:center;gap:0.4rem;margin-bottom:0.2rem;}
.chat-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.chat-agent{font-family:'Syne',sans-serif;font-weight:700;font-size:0.72rem;}
.chat-arrow{font-size:0.65rem;color:var(--text-muted);}
.chat-target{font-family:'Syne',sans-serif;font-weight:600;font-size:0.72rem;color:var(--text-dim);}
.chat-num{margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--text-muted);}
.chat-bubble{padding:0.5rem 0.7rem;border-radius:8px;font-size:0.76rem;line-height:1.5;margin-left:0.6rem;}
.chat-bubble.challenge{background:rgba(255,75,87,0.06);border:1px solid rgba(255,75,87,0.12);border-left:2px solid;}
.chat-bubble.response{background:rgba(0,232,143,0.04);border:1px solid rgba(0,232,143,0.1);border-left:2px solid var(--accept);}
.chat-status{display:inline-block;padding:0.05rem 0.3rem;border-radius:3px;font-size:0.6rem;font-weight:700;font-family:'JetBrains Mono',monospace;margin-top:0.25rem;}
.chat-status.s-accepted{background:rgba(0,232,143,0.15);color:var(--accept);}
.chat-status.s-partial{background:rgba(255,210,63,0.15);color:var(--partial);}
.chat-status.s-rejected{background:rgba(255,71,87,0.15);color:var(--reject);}
.chat-divider{text-align:center;padding:0.5rem;font-size:0.65rem;color:var(--text-muted);font-family:'JetBrains Mono',monospace;position:relative;margin:0.5rem 0;}
.chat-divider::before,.chat-divider::after{content:'';position:absolute;top:50%;width:25%;height:1px;background:var(--border);}
.chat-divider::before{left:5%;}
.chat-divider::after{right:5%;}

/* ===== TIMELINE SCRUBBER ===== */
.timeline-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:0.75rem 1rem;}
.timeline-track{position:relative;height:32px;display:flex;align-items:center;margin-bottom:0.4rem;}
.timeline-line{position:absolute;left:0;right:0;top:50%;height:2px;background:var(--border);transform:translateY(-50%);}
.timeline-progress{position:absolute;left:0;top:50%;height:2px;background:var(--hoac);transform:translateY(-50%);transition:width 0.5s ease;border-radius:1px;}
.timeline-dots{position:relative;display:flex;justify-content:space-between;width:100%;z-index:1;}
.tl-dot{width:24px;height:24px;border-radius:50%;background:var(--surface2);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:0.55rem;font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--text-muted);cursor:pointer;transition:all 0.3s;position:relative;}
.tl-dot:hover{border-color:var(--text-dim);color:var(--text);}
.tl-dot.visited{border-color:var(--hoac);color:var(--hoac);background:rgba(77,143,255,0.1);}
.tl-dot.current{border-color:var(--hoac);background:var(--hoac);color:#fff;transform:scale(1.2);box-shadow:0 0 12px rgba(77,143,255,0.4);}
.tl-dot .tl-tooltip{display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--surface3);border:1px solid var(--border);border-radius:6px;padding:0.25rem 0.5rem;font-size:0.6rem;white-space:nowrap;color:var(--text);pointer-events:none;}
.tl-dot:hover .tl-tooltip{display:block;}
.timeline-label{font-size:0.7rem;color:var(--text-dim);text-align:center;}

/* Legend */
.network-legend{display:flex;gap:1.5rem;margin-top:0.75rem;flex-wrap:wrap;}
.legend-item{display:flex;align-items:center;gap:0.4rem;font-size:0.72rem;color:var(--text-dim);}
.legend-dot{width:8px;height:8px;border-radius:50%;}

/* Interaction detail panel (click mode) */
.interaction-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;margin-top:1rem;overflow:hidden;max-height:0;transition:max-height 0.5s ease,opacity 0.3s;opacity:0;}
.interaction-panel.open{max-height:2000px;opacity:1;}
.interaction-panel-header{display:flex;align-items:center;gap:0.75rem;padding:1rem 1.25rem;border-bottom:1px solid var(--border);}
.close-panel{margin-left:auto;background:none;border:none;color:var(--text-dim);font-size:1.2rem;cursor:pointer;padding:0.25rem;}
.close-panel:hover{color:var(--text);}
.interaction-list{padding:0.75rem 1.25rem;}
.interaction-item{display:grid;grid-template-columns:auto 1fr auto 1fr;gap:0.75rem;align-items:start;padding:0.75rem 0;border-bottom:1px solid rgba(255,255,255,0.04);}
.interaction-item:last-child{border-bottom:none;}
.int-num{font-family:'JetBrains Mono',monospace;font-size:0.7rem;font-weight:600;color:var(--text-muted);width:20px;text-align:right;padding-top:0.15rem;}
.int-challenge{background:rgba(255,75,87,0.08);border:1px solid rgba(255,75,87,0.15);border-radius:8px;padding:0.5rem 0.75rem;font-size:0.8rem;}
.int-arrow{color:var(--text-muted);font-size:1.1rem;text-align:center;padding-top:0.25rem;}
.int-response{background:rgba(0,232,143,0.06);border:1px solid rgba(0,232,143,0.12);border-radius:8px;padding:0.5rem 0.75rem;font-size:0.8rem;}
.int-status{display:inline-block;padding:0.1rem 0.4rem;border-radius:3px;font-size:0.65rem;font-weight:700;font-family:'JetBrains Mono',monospace;margin-top:0.3rem;}
.status-accepted{background:rgba(0,232,143,0.15);color:var(--accept);}
.status-rejected{background:rgba(255,71,87,0.15);color:var(--reject);}
.status-partial{background:rgba(255,210,63,0.15);color:var(--partial);}

/* ===== DEBATE VIEW ===== */
.round-section{margin-bottom:2rem;}
.round-title{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem;}
.round-badge{background:var(--surface2);border:1px solid var(--border);padding:0.15rem 0.6rem;border-radius:12px;font-size:0.7rem;font-weight:600;color:var(--text-dim);}
.agent-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:1rem;}
.agent-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;transition:transform 0.2s,box-shadow 0.3s;}
.agent-card:hover{transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,0.3);}
.agent-card-hdr{padding:0.75rem 1rem;display:flex;align-items:center;gap:0.5rem;}
.agent-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.agent-name{font-family:'Syne',sans-serif;font-weight:700;font-size:0.85rem;}
.agent-role-tag{margin-left:auto;font-size:0.65rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace;}
.agent-card-body{padding:0 1rem 1rem;font-size:0.8rem;max-height:350px;overflow-y:auto;}
.agent-card-body::-webkit-scrollbar{width:3px;}
.agent-card-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.card-item{padding:0.4rem 0.6rem;border-radius:6px;margin-bottom:0.4rem;font-size:0.78rem;}
.card-challenge{background:rgba(255,123,58,0.08);border-left:2px solid var(--bias);}
.card-accept{background:rgba(0,232,143,0.06);border-left:2px solid var(--accept);}
.card-reject{background:rgba(255,71,87,0.06);border-left:2px solid var(--reject);}
.card-new{background:rgba(191,109,255,0.06);border-left:2px solid var(--clini);}
.card-critical{background:rgba(255,71,87,0.08);border-left:2px solid var(--reject);}
.tag{display:inline-block;padding:0.05rem 0.35rem;border-radius:3px;font-size:0.6rem;font-weight:700;font-family:'JetBrains Mono',monospace;margin-right:0.3rem;}
.tag-accept{background:rgba(0,232,143,0.2);color:var(--accept);}
.tag-reject{background:rgba(255,71,87,0.2);color:var(--reject);}
.tag-challenge{background:rgba(255,123,58,0.2);color:var(--bias);}
.tag-new{background:rgba(191,109,255,0.2);color:var(--clini);}
.tag-critical{background:rgba(255,71,87,0.25);color:var(--reject);}
.tag-partial{background:rgba(255,210,63,0.2);color:var(--partial);}
.tag-validated{background:rgba(0,232,143,0.2);color:var(--accept);}

/* ===== CLINICAL VIEW ===== */
.section-title{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;margin:1.5rem 0 1rem;display:flex;align-items:center;gap:0.5rem;}
.section-title:first-child{margin-top:0;}
.outcomes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1rem;}
.outcome-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1.2rem;position:relative;overflow:hidden;}
.outcome-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.oc-walking::before{background:var(--hoac);}
.oc-ul::before{background:var(--reject);}
.oc-transfer::before{background:var(--accept);}
.oc-stairs::before{background:var(--partial);}
.oc-cross::before{background:var(--lit);}
.outcome-card h3{font-family:'Syne',sans-serif;font-size:0.9rem;font-weight:700;margin-bottom:0.5rem;}
.icf-badge{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:0.7rem;font-weight:600;padding:0.1rem 0.5rem;border-radius:4px;background:rgba(77,143,255,0.12);color:var(--hoac);margin-bottom:0.5rem;}
.metrics-row{display:flex;flex-wrap:wrap;gap:0.4rem;margin:0.5rem 0;}
.metric{background:var(--surface2);padding:0.2rem 0.5rem;border-radius:5px;font-size:0.72rem;font-family:'JetBrains Mono',monospace;}
.metric .v{font-weight:700;color:var(--hoac);}
.hyp-box{background:var(--surface2);border-radius:8px;padding:0.6rem 0.75rem;margin-top:0.6rem;font-size:0.78rem;border-left:3px solid var(--hoac);}
.hyp-box.competing{border-left-color:var(--bias);}
.hyp-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);margin-bottom:0.2rem;font-weight:600;}
.oc-targets{margin-top:0.6rem;font-size:0.75rem;color:var(--text-dim);}
.oc-targets strong{color:var(--text);}
.cascade-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1.25rem;overflow-x:auto;}
.cascade-row{display:flex;align-items:stretch;margin-bottom:0.35rem;font-size:0.78rem;min-width:600px;}
.cascade-wk{width:65px;flex-shrink:0;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--hoac);padding:0.4rem 0.5rem;display:flex;align-items:center;font-size:0.72rem;}
.cascade-trigger{flex:1;background:var(--surface2);padding:0.4rem 0.7rem;border-radius:5px 0 0 5px;border-right:2px solid var(--hoac);font-size:0.75rem;}
.cascade-action{flex:1;padding:0.4rem 0.7rem;background:rgba(77,143,255,0.05);border-radius:0 5px 5px 0;font-size:0.75rem;}
.budget-item{margin-bottom:0.6rem;}
.budget-meta{display:flex;justify-content:space-between;font-size:0.78rem;margin-bottom:0.2rem;}
.budget-bar{height:22px;background:var(--surface2);border-radius:6px;overflow:hidden;}
.budget-fill{height:100%;border-radius:6px;display:flex;align-items:center;padding-left:0.5rem;font-size:0.65rem;font-weight:700;color:#fff;font-family:'JetBrains Mono',monospace;}

/* ===== DATA VIEW ===== */
.data-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;}
.icf-section{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1rem;}
.icf-section h4{font-family:'Syne',sans-serif;font-size:0.85rem;font-weight:700;margin-bottom:0.6rem;}
.icf-row{display:flex;justify-content:space-between;align-items:center;padding:0.3rem 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.75rem;}
.icf-row:last-child{border-bottom:none;}
.q{display:inline-block;width:26px;height:26px;border-radius:5px;text-align:center;line-height:26px;font-weight:700;font-size:0.7rem;font-family:'JetBrains Mono',monospace;}
.q0{background:rgba(0,232,143,0.15);color:var(--accept);}
.q1{background:rgba(255,210,63,0.15);color:var(--partial);}
.q2{background:rgba(255,123,58,0.15);color:var(--bias);}
.q3{background:rgba(255,71,87,0.15);color:var(--reject);}
.q4{background:rgba(160,40,60,0.2);color:#fca5a5;}
.qp{background:rgba(0,232,143,0.15);color:var(--accept);}
.qn{background:rgba(255,71,87,0.15);color:var(--reject);}
.evidence-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem;}
.ev-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1rem;}
.ev-card h4{font-family:'Syne',sans-serif;font-size:0.85rem;font-weight:700;margin-bottom:0.5rem;}
.verdict{display:inline-block;padding:0.15rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:700;font-family:'JetBrains Mono',monospace;}
.v-validated{background:rgba(0,232,143,0.15);color:var(--accept);}
.v-partial{background:rgba(255,210,63,0.15);color:var(--partial);}
.ev-detail{font-size:0.75rem;color:var(--text-dim);margin-top:0.5rem;line-height:1.5;}
.pmid{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--lit);}
.measure-wrap{overflow-x:auto;}
.mtable{width:100%;border-collapse:collapse;font-size:0.75rem;}
.mtable th{text-align:left;padding:0.5rem;background:var(--surface2);border-bottom:2px solid var(--border);font-size:0.68rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);font-family:'JetBrains Mono',monospace;}
.mtable td{padding:0.4rem 0.5rem;border-bottom:1px solid rgba(255,255,255,0.04);}
.mtable tr:hover{background:rgba(77,143,255,0.03);}
.consensus-list{list-style:none;}
.consensus-list li{padding:0.5rem 0.75rem;margin-bottom:0.3rem;border-radius:8px;font-size:0.8rem;display:flex;gap:0.5rem;align-items:flex-start;}
.cons-item{background:rgba(0,232,143,0.05);border:1px solid rgba(0,232,143,0.1);}
.dis-item{background:rgba(255,210,63,0.05);border:1px solid rgba(255,210,63,0.1);}
.cons-icon{flex-shrink:0;width:18px;text-align:center;font-size:0.85rem;}

@media(max-width:900px){
  .network-split{grid-template-columns:1fr;}
  .chat-panel{max-height:300px;}
  .agent-cards{grid-template-columns:1fr;}
  .outcomes-grid{grid-template-columns:1fr;}
  .interaction-item{grid-template-columns:auto 1fr;}
  .int-arrow,.int-response{display:none;}
  .nav{overflow-x:auto;padding:0 1rem;}
  .content{padding:1rem;}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <div><h1>CRISP Multi-Agent Clinical Reasoning</h1></div>
    <div class="patient-badge"><div><div class="name">Maria van den Berg</div><div class="detail">68F &middot; Left MCA stroke &middot; Day 12 &middot; Inpatient Rehab</div></div></div>
  </div>
  <div class="stats-strip">
    <div class="stat-chip"><span class="val">6</span> Agents</div>
    <div class="stat-chip"><span class="val">2</span> Rounds</div>
    <div class="stat-chip"><span class="val">12</span> Interactions</div>
    <div class="stat-chip"><span class="val">16</span> Accepted</div>
    <div class="stat-chip"><span class="val">4</span> Rejected</div>
    <div class="stat-chip"><span class="val">6</span> PubMed</div>
    <div class="stat-chip"><span class="val">6</span> Biases Fixed</div>
    <div class="stat-chip"><span class="val">180</span> min/day</div>
    <div class="stat-chip"><span class="val">25%</span> UL Recovery</div>
  </div>
</div>

<nav class="nav">
  <button class="nav-btn active" onclick="showPanel('network')">Agent Network</button>
  <button class="nav-btn" onclick="showPanel('debate')">Debate Rounds</button>
  <button class="nav-btn" onclick="showPanel('clinical')">Clinical Plan</button>
  <button class="nav-btn" onclick="showPanel('data')">Data & Evidence</button>
</nav>

<div class="content">

<!-- ===== NETWORK PANEL ===== -->
<div id="network" class="panel active">
  <div class="network-header">
    <h2>Agent Interaction Map</h2>
    <div class="replay-controls">
      <button class="speed-btn active" data-speed="1" onclick="setSpeed(1)">1x</button>
      <button class="speed-btn" data-speed="2" onclick="setSpeed(2)">2x</button>
      <button class="speed-btn" data-speed="0.5" onclick="setSpeed(0.5)">0.5x</button>
      <button class="replay-btn" id="replayBtn" onclick="replayDebate()">&#9654; Replay Debate</button>
    </div>
  </div>
  <div class="network-split">
    <div>
      <div class="network-svg-wrap">
        <svg id="networkSvg" viewBox="0 0 900 520" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <marker id="arrow-hoac" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#4d8fff" opacity="0.7"/></marker>
            <marker id="arrow-icf" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#00e88f" opacity="0.7"/></marker>
            <marker id="arrow-neuro" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#ffd23f" opacity="0.7"/></marker>
            <marker id="arrow-clini" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#bf6dff" opacity="0.7"/></marker>
            <marker id="arrow-bias" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#ff7b3a" opacity="0.7"/></marker>
            <marker id="arrow-lit" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6" fill="#ff5ca1" opacity="0.7"/></marker>
            <filter id="glow"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            <filter id="glowStrong"><feGaussianBlur stdDeviation="10" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          </defs>
          <pattern id="grid" width="30" height="30" patternUnits="userSpaceOnUse"><path d="M 30 0 L 0 0 0 30" fill="none" stroke="rgba(255,255,255,0.02)" stroke-width="0.5"/></pattern>
          <rect width="900" height="520" fill="url(#grid)"/>
          <g id="connections"></g>
          <g id="pulseLayer"></g>
          <g id="countBadges"></g>
          <g id="agentNodes"></g>
        </svg>
      </div>
      <div class="network-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--hoac)"></div>HOAC-Coach</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--icf)"></div>ICF-Mapper</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--neuro)"></div>Neuro-Evidence</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--clini)"></div>Clinimetrics</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--bias)"></div>Bias-Reflector</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--lit)"></div>Literature Agent</div>
      </div>
    </div>
    <div class="chat-panel">
      <div class="chat-header"><div class="live-dot" id="liveDot"></div> Debate Transcript</div>
      <div class="chat-body" id="chatBody">
        <div class="chat-empty"><p>&#128172;</p><p>Click a connection or hit Replay<br>to watch the debate unfold</p></div>
      </div>
    </div>
  </div>
  <!-- Timeline -->
  <div class="timeline-wrap" id="timelineWrap">
    <div class="timeline-track">
      <div class="timeline-line"></div>
      <div class="timeline-progress" id="tlProgress"></div>
      <div class="timeline-dots" id="tlDots"></div>
    </div>
    <div class="timeline-label" id="tlLabel">Click a dot to jump to an interaction</div>
  </div>
  <div class="interaction-panel" id="interactionPanel"></div>
</div>

<!-- ===== DEBATE PANEL ===== -->
<div id="debate" class="panel">
  <div class="round-section">
    <div class="round-title">Round 1 <span class="round-badge">Sequential &middot; Opening Positions</span></div>
    <div class="agent-cards">
      <div class="agent-card" style="border-top:2px solid var(--hoac);"><div class="agent-card-hdr" style="background:rgba(77,143,255,0.06);"><div class="agent-dot" style="background:var(--hoac)"></div><span class="agent-name">HOAC-Coach</span><span class="agent-role-tag">HOAC-II</span></div><div class="agent-card-body"><p style="margin-bottom:0.5rem;font-weight:600;">4 Functional Problems:</p><div class="card-item card-new"><span class="tag tag-new">d450.3</span>Walking: BBS 24 as primary mediator. Exit: BBS 35. Competing: foot drop</div><div class="card-item card-new"><span class="tag tag-new">d445.4</span>UL Function: Flexor synergy dominance. ARAT 12/57. Exit: ARAT MCID 5.7</div><div class="card-item card-new"><span class="tag tag-new">d420.3</span>Transfers: Weight-shift deficit. 30+ STS reps/day</div><div class="card-item card-new"><span class="tag tag-new">d455.4</span>Stairs: Deferred until BBS 35+. Parallel-path strategy</div></div></div>
      <div class="agent-card" style="border-top:2px solid var(--icf);"><div class="agent-card-hdr" style="background:rgba(0,232,143,0.06);"><div class="agent-dot" style="background:var(--icf)"></div><span class="agent-name">ICF-Mapper</span><span class="agent-role-tag">ICF Framework</span></div><div class="agent-card-body"><p style="margin-bottom:0.5rem;font-weight:600;">6 Challenges to HOAC-Coach:</p><div class="card-item card-critical"><span class="tag tag-reject">REJECTED</span>Goal #4 (shoulder flexion 90&deg;) &mdash; pure impairment, no d-code</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>Missing b152 emotional functions</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>e310 (Hans) needs dual coding</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>e155 needs time-gated decisions</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>Missing d910, d230 participation codes</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>Missing s-codes (s110.3)</div></div></div>
      <div class="agent-card" style="border-top:2px solid var(--neuro);"><div class="agent-card-hdr" style="background:rgba(255,210,63,0.06);"><div class="agent-dot" style="background:var(--neuro)"></div><span class="agent-name">Neuro-Evidence</span><span class="agent-role-tag">Evidence Critique</span></div><div class="agent-card-body"><div class="card-item card-critical"><span class="tag tag-critical">CRITICAL</span>Therapy ~110-140 min/day vs 180 min guideline</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>UL: EPOS unfavorable, need 300-400 reps</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>Gait: need 1000-2000 steps/session</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>Balance: 20 min subtherapeutic</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>STS: evidence supports 50-100/day</div></div></div>
      <div class="agent-card" style="border-top:2px solid var(--clini);"><div class="agent-card-hdr" style="background:rgba(191,109,255,0.06);"><div class="agent-dot" style="background:var(--clini)"></div><span class="agent-name">Clinimetrics</span><span class="agent-role-tag">Outcomes</span></div><div class="agent-card-body"><div class="card-item card-critical"><span class="tag tag-critical">NON-NEGOTIABLE</span>FMA-UE must be added</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>MoCA must replace MMSE</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>Every goal needs validated tool + MCID</div><div class="card-item card-new"><span class="tag tag-new">PROPOSED</span>Reassessment schedule wk 2, 4, 6</div></div></div>
      <div class="agent-card" style="border-top:2px solid var(--bias);"><div class="agent-card-hdr" style="background:rgba(255,123,58,0.06);"><div class="agent-dot" style="background:var(--bias)"></div><span class="agent-name">Bias-Reflector</span><span class="agent-role-tag">Bias Detection</span></div><div class="agent-card-body"><div class="card-item card-critical"><span class="tag tag-critical">DETECTED</span><strong>Motor bias:</strong> All 4 problems motor-framed</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>Attention may rate-limit more than weakness</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>d445.4 anchoring: &ldquo;complete = no point&rdquo;</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>Hans as co-patient needs assessment</div><div class="card-item card-challenge"><span class="tag tag-challenge">CHALLENGE</span>Linear recovery assumption</div></div></div>
      <div class="agent-card" style="border-top:2px solid var(--lit);"><div class="agent-card-hdr" style="background:rgba(255,92,161,0.06);"><div class="agent-dot" style="background:var(--lit)"></div><span class="agent-name">Literature Agent</span><span class="agent-role-tag">PubMed</span></div><div class="agent-card-body"><p style="margin-bottom:0.5rem;font-weight:600;">6 Claims Validated:</p><div class="card-item card-challenge"><span class="tag tag-partial">PARTIAL</span>180 min/day &mdash; NICE yes, KNGF lower</div><div class="card-item card-accept"><span class="tag tag-validated">VALIDATED</span>EPOS/PREP2 25% confirmed</div><div class="card-item card-challenge"><span class="tag tag-partial">PARTIAL</span>1000-2000 steps &mdash; conservative</div><div class="card-item card-challenge"><span class="tag tag-partial">PARTIAL</span>300-400 UL reps &mdash; extrapolated</div><div class="card-item card-challenge"><span class="tag tag-partial">PARTIAL</span>Perturbation &mdash; mixed populations</div><div class="card-item card-challenge"><span class="tag tag-partial">PARTIAL</span>TCT &gt;50 &mdash; requires TCT+MI-LE</div></div></div>
    </div>
  </div>
  <div class="round-section">
    <div class="round-title">Round 2 <span class="round-badge">Parallel &middot; Responses</span></div>
    <div class="agent-cards">
      <div class="agent-card" style="border-top:2px solid var(--hoac);"><div class="agent-card-hdr" style="background:rgba(77,143,255,0.06);"><div class="agent-dot" style="background:var(--hoac)"></div><span class="agent-name">HOAC-Coach R2</span><span class="agent-role-tag">16 accepted, 4 rejected</span></div><div class="agent-card-body"><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>Goal #4 reframed to d445/d660</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>b152 as mediator + FES-I</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>Hans wk 3 gate</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>180 min/day budget</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>Step-count targets 500&rarr;2000</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>300+ UL reps</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>STS 50-100/day</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>Attention mediator + MoCA</div><div class="card-item card-reject"><span class="tag tag-reject">REJECTED</span>Fixed 60/40 ratio</div><div class="card-item card-reject"><span class="tag tag-reject">REJECTED</span>Standalone psychosocial problem</div><div class="card-item card-reject"><span class="tag tag-reject">REJECTED</span>Hans as co-patient</div><div class="card-item card-reject"><span class="tag tag-reject">REJECTED</span>d620/d910 as inpatient goals</div></div></div>
      <div class="agent-card" style="border-top:2px solid var(--icf);"><div class="agent-card-hdr" style="background:rgba(0,232,143,0.06);"><div class="agent-dot" style="background:var(--icf)"></div><span class="agent-name">ICF-Mapper R2</span><span class="agent-role-tag">7 accepted</span></div><div class="agent-card-body"><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>d445 split: cap .3 / perf .4</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>ICF-outcome mapping</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>b152 elevated .1&rarr;.2</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>Cap/perf across all d-codes</div></div></div>
      <div class="agent-card" style="border-top:2px solid var(--neuro);"><div class="agent-card-hdr" style="background:rgba(255,210,63,0.06);"><div class="agent-dot" style="background:var(--neuro)"></div><span class="agent-name">Neuro-Evidence R2</span><span class="agent-role-tag">5 accepted</span></div><div class="agent-card-body"><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>Measurement framework</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>Self-efficacy elevated</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>Spasticity decision tree</div><div class="card-item card-reject"><span class="tag tag-reject">MAINTAINED</span>Motor training PRIMARY</div></div></div>
      <div class="agent-card" style="border-top:2px solid var(--clini);"><div class="agent-card-hdr" style="background:rgba(191,109,255,0.06);"><div class="agent-dot" style="background:var(--clini)"></div><span class="agent-name">Clinimetrics R2</span><span class="agent-role-tag">All accepted</span></div><div class="agent-card-body"><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>PHQ-9, FES-I, SSEQ, TMT, CSI</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>Spasticity protocol</div><div class="card-item card-accept"><span class="tag tag-accept">ACCEPTED</span>ICF-Measurement Crosswalk</div><div class="card-item card-challenge"><span class="tag tag-challenge">FLAGGED</span>17 measures &rarr; split 2 sessions</div></div></div>
      <div class="agent-card" style="border-top:2px solid var(--bias);"><div class="agent-card-hdr" style="background:rgba(255,123,58,0.06);"><div class="agent-dot" style="background:var(--bias)"></div><span class="agent-name">Bias-Reflector R2</span><span class="agent-role-tag">Evaluation</span></div><div class="agent-card-body"><div class="card-item card-accept"><span class="tag tag-accept">RESOLVED</span>d445 anchoring</div><div class="card-item card-accept"><span class="tag tag-accept">RESOLVED</span>Hans dual-coding</div><div class="card-item card-accept"><span class="tag tag-accept">LARGELY RESOLVED</span>Motor bias</div><div class="card-item card-challenge"><span class="tag tag-challenge">NOT RESOLVED</span>Attention not formalised</div><div class="card-item card-challenge"><span class="tag tag-challenge">NEW</span>&ldquo;Dosage dogmatism&rdquo;</div></div></div>
    </div>
  </div>
</div>

<!-- ===== CLINICAL PANEL ===== -->
<div id="clinical" class="panel">
  <div class="section-title">Functional Problems</div>
  <div class="outcomes-grid">
    <div class="outcome-card oc-walking"><span class="icf-badge">d450.3/.4</span><h3>Problem 1: Unable to Walk Independently</h3><div class="metrics-row"><span class="metric">FAC <span class="v">2</span></span><span class="metric">BBS <span class="v">24/56</span></span><span class="metric">MI LL <span class="v">64</span></span></div><div class="hyp-box"><div class="hyp-label">Primary Hypothesis</div>Insufficient affected-limb weight acceptance during stance (balance + strength)</div><div class="hyp-box competing"><div class="hyp-label">Competing</div>Foot drop (dorsiflexion MRC 3) &mdash; test: FAC with/without AFO</div><div class="oc-targets"><strong>Target:</strong> FAC 4, BBS &gt;41, 50m by wk 6<br><strong>Exit:</strong> BBS 35 &rarr; add challenges; 10MWT &lt;0.10 &rarr; BWSTT</div></div>
    <div class="outcome-card oc-ul"><span class="icf-badge">d445 cap:.3/perf:.4</span><h3>Problem 2: Unable to Use Right Hand</h3><div class="metrics-row"><span class="metric">ARAT <span class="v">12/57</span></span><span class="metric">MI UL <span class="v">42</span></span><span class="metric">PREP2 <span class="v">Limited</span></span></div><div class="hyp-box"><div class="hyp-label">Primary Hypothesis</div>Flexor synergy dominance + proprioceptive deficit as interacting mediator</div><div class="hyp-box competing"><div class="hyp-label">Competing</div>Learned non-use / psychological withdrawal</div><div class="oc-targets"><strong>PREP2:</strong> ~25% probability<br><strong>Exit:</strong> ARAT MCID 5.7 or FMA-UE 5.25 at wk 4</div></div>
    <div class="outcome-card oc-transfer"><span class="icf-badge">d420.3</span><h3>Problem 3: Unable to Transfer</h3><div class="metrics-row"><span class="metric">STS <span class="v">Mod Assist</span></span><span class="metric">TCT <span class="v">74</span></span></div><div class="hyp-box"><div class="hyp-label">Primary</div>Inadequate weight shift to right during STS</div><div class="hyp-box competing"><div class="hyp-label">Competing</div>Fear/low self-efficacy (b152)</div><div class="oc-targets"><strong>Target:</strong> 50-100 STS/day; standby by wk 2<br><strong>Critical:</strong> Hans CSI at wk 3</div></div>
    <div class="outcome-card oc-stairs"><span class="icf-badge">d455.4/e155.-3</span><h3>Problem 4: Stairs</h3><div class="metrics-row"><span class="metric">Status <span class="v">Not assessed</span></span><span class="metric">Home <span class="v">12 steps</span></span></div><div class="hyp-box"><div class="hyp-label">Primary</div>BBS insufficient for single-limb stance on step</div><div class="oc-targets"><strong>Wk 3:</strong> BBS &lt;30 &rarr; stairlift<br><strong>Wk 5:</strong> &lt;4 stairs &rarr; confirm mod<br><strong>Strategy:</strong> Train AND modify simultaneously</div></div>
    <div class="outcome-card oc-cross" style="grid-column:1/-1;"><span class="icf-badge" style="background:rgba(255,92,161,0.12);color:var(--lit);">b164.1+b152.2</span><h3>Cross-Cutting Mediators</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:0.5rem;font-size:0.8rem;"><div><strong>Attention (b164.1)</strong><br>MMSE 25. Rate-limits motor learning. MoCA + TMT-A/B, 15-20 min blocks.</div><div><strong>Emotional (b152.2)</strong><br>Fear of being burden. PHQ-9 (&ge;10 &rarr; standalone), FES-I, SSEQ.</div></div></div>
  </div>
  <div class="section-title">Decision Cascade</div>
  <div class="cascade-wrap">
    <div class="cascade-row"><div class="cascade-wk">WK 2</div><div class="cascade-trigger">Finger ext + FMA-UE &ge;20</div><div class="cascade-action">UL &rarr; 70/30 recovery/comp</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 2</div><div class="cascade-trigger">No finger ext + FMA-UE &lt;15</div><div class="cascade-action">UL &rarr; 40/60 (shift at wk 4)</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 2</div><div class="cascade-trigger">FAC 2 + 10MWT &lt;0.10 gain</div><div class="cascade-action">Escalate BWSTT</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 2</div><div class="cascade-trigger">BBS change &lt;4 pts</div><div class="cascade-action">Investigate: sensory/attention/fear</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 3</div><div class="cascade-trigger">BBS &lt;30</div><div class="cascade-action">Stairlift assessment</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 3</div><div class="cascade-trigger">Hans CSI &ge;7</div><div class="cascade-action">Revise discharge plan</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 3</div><div class="cascade-trigger">MAS &ge;2 + interference</div><div class="cascade-action">Botulinum referral</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 3</div><div class="cascade-trigger">Trajectory BEHIND</div><div class="cascade-action">Team meeting: audit dose</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 4</div><div class="cascade-trigger">FMA-UE &lt;20 + ARAT &lt;10</div><div class="cascade-action">Compensation-dominant UL</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 4</div><div class="cascade-trigger">FMA-UE &gt;30 + grip &ge;3</div><div class="cascade-action">Add modified CIMT</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 5</div><div class="cascade-trigger">&lt;4 stairs with rail</div><div class="cascade-action">Confirm modification</div></div>
    <div class="cascade-row"><div class="cascade-wk">WK 6</div><div class="cascade-trigger">Full battery + stair + CSI</div><div class="cascade-action">Discharge decision</div></div>
  </div>
  <div class="section-title">Therapy Budget: 180 min/day</div>
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1.25rem;">
    <div class="budget-item"><div class="budget-meta"><span>Gait Training</span><span>45 min &middot; 500-2000 steps</span></div><div class="budget-bar"><div class="budget-fill" style="width:25%;background:var(--hoac);">45</div></div></div>
    <div class="budget-item"><div class="budget-meta"><span>Standing Balance</span><span>30 min</span></div><div class="budget-bar"><div class="budget-fill" style="width:16.7%;background:var(--neuro);">30</div></div></div>
    <div class="budget-item"><div class="budget-meta"><span>STS / Transfer</span><span>15 min &middot; 50-100 reps</span></div><div class="budget-bar"><div class="budget-fill" style="width:8.3%;background:var(--icf);">15</div></div></div>
    <div class="budget-item"><div class="budget-meta"><span>UL Rehabilitation</span><span>60 min &middot; 300+ reps</span></div><div class="budget-bar"><div class="budget-fill" style="width:33.3%;background:var(--reject);">60</div></div></div>
    <div class="budget-item"><div class="budget-meta"><span>ADL / Functional</span><span>30 min</span></div><div class="budget-bar"><div class="budget-fill" style="width:16.7%;background:var(--clini);">30</div></div></div>
  </div>
</div>

<!-- ===== DATA PANEL ===== -->
<div id="data" class="panel">
  <div class="section-title">ICF Map</div>
  <div class="data-grid">
    <div class="icf-section"><h4 style="color:var(--hoac);">b Body Functions</h4><div class="icf-row"><span>b730 Muscle power</span><span class="q q3">.3</span></div><div class="icf-row"><span>b735 Muscle tone</span><span class="q q1">.1</span></div><div class="icf-row"><span>b760 Voluntary movement</span><span class="q q3">.3</span></div><div class="icf-row"><span>b770 Gait pattern</span><span class="q q3">.3</span></div><div class="icf-row"><span>b260 Proprioception</span><span class="q q2">.2</span></div><div class="icf-row"><span>b755 Balance</span><span class="q q3">.3</span></div><div class="icf-row"><span>b164 Higher cognitive</span><span class="q q1">.1</span></div><div class="icf-row"><span>b320 Articulation</span><span class="q q1">.1</span></div><div class="icf-row"><span>b152 Emotional</span><span class="q q2">.2</span></div></div>
    <div class="icf-section"><h4 style="color:var(--clini);">s Body Structures</h4><div class="icf-row"><span>s110 Brain</span><span class="q q3">.3</span></div><div class="icf-row"><span>s720 Shoulder</span><span class="q q1">.1</span></div><div class="icf-row"><span>s750 Lower ext</span><span class="q q2">.2</span></div></div>
    <div class="icf-section"><h4 style="color:var(--icf);">d Activities</h4><div class="icf-row"><span>d410 Body position</span><span class="q q2">.2</span></div><div class="icf-row"><span>d420 Transferring</span><span class="q q3">.3</span></div><div class="icf-row"><span>d445 Hand/arm</span><span><span class="q q3" style="margin-right:3px">.3</span><span class="q q4">.4</span></span></div><div class="icf-row"><span>d450 Walking</span><span><span class="q q3" style="margin-right:3px">.3</span><span class="q q4">.4</span></span></div><div class="icf-row"><span>d455 Stairs</span><span class="q q4">.4</span></div><div class="icf-row"><span>d510 Washing</span><span class="q q3">.3</span></div><div class="icf-row"><span>d540 Dressing</span><span class="q q3">.3</span></div><div class="icf-row"><span>d550 Eating</span><span class="q q2">.2</span></div></div>
    <div class="icf-section"><h4 style="color:var(--neuro);">d Participation</h4><div class="icf-row"><span>d660 Assisting others</span><span class="q q4">.4</span></div><div class="icf-row"><span>d620 Shopping</span><span class="q q4">.4</span></div><div class="icf-row"><span>d920 Recreation</span><span class="q q4">.4</span></div><div class="icf-row"><span>d910 Community</span><span class="q q4">.4</span></div><div class="icf-row"><span>d230 Daily routine</span><span class="q q3">.3</span></div></div>
    <div class="icf-section"><h4 style="color:var(--lit);">e Environmental</h4><div class="icf-row"><span>e310 Hans</span><span><span class="q qp">+3</span> <span class="q qn">-1</span></span></div><div class="icf-row"><span>e315 Family</span><span class="q qp">+3</span></div><div class="icf-row"><span>e155 Stairs</span><span class="q qn">-3</span></div><div class="icf-row"><span>e120 Mobility equip</span><span class="q qp">+2</span></div><div class="icf-row"><span>e580 Health services</span><span class="q qp">+2</span></div><div class="icf-row"><span>e115 Adaptive equip</span><span class="q qp">+1</span></div></div>
    <div class="icf-section"><h4>Personal Factors</h4><div class="icf-row"><span>Motivation</span><span style="color:var(--accept);font-weight:700;font-size:0.75rem;">High</span></div><div class="icf-row"><span>Fear of burden</span><span style="color:var(--reject);font-weight:700;font-size:0.75rem;">Present</span></div><div class="icf-row"><span>Self-efficacy</span><span style="color:var(--reject);font-weight:700;font-size:0.75rem;">Low</span></div><div class="icf-row"><span>Activity level</span><span style="color:var(--accept);font-weight:700;font-size:0.75rem;">Active</span></div></div>
  </div>
  <div class="section-title">Evidence Validation</div>
  <div class="evidence-grid">
    <div class="ev-card"><h4>180 min/day</h4><span class="verdict v-partial">PARTIAL</span><div class="ev-detail">NICE (UK), AHA/ASA 2016 <span class="pmid">PMID 27145936</span>. KNGF baseline lower. Ontario 2024: 0% compliance.</div></div>
    <div class="ev-card"><h4>EPOS/PREP2</h4><span class="verdict v-validated">VALIDATED</span><div class="ev-detail">Nijland 2010 <span class="pmid">PMID 20167916</span>: 25% at 6mo. Stinear 2017 <span class="pmid">PMID 29159193</span>: PREP2 validated.</div></div>
    <div class="ev-card"><h4>1000-2000 Steps</h4><span class="verdict v-partial">PARTIAL</span><div class="ev-detail">Hornby 2020 <span class="pmid">PMID 31834165</span>. Moore 2023: mean 2460. CPG is chronic, not subacute.</div></div>
    <div class="ev-card"><h4>300-400 UL Reps</h4><span class="verdict v-partial">PARTIAL</span><div class="ev-detail">Lang 2009 <span class="pmid">PMID 19801058</span>: typical=32. Lohse 2014: g=0.35. Threshold extrapolated.</div></div>
    <div class="ev-card"><h4>Perturbation Training</h4><span class="verdict v-partial">PARTIAL</span><div class="ev-detail">Mansfield 2015 <span class="pmid">PMID 25524873</span>: RR=0.71. Handelzalts 2019: subacute RCT.</div></div>
    <div class="ev-card"><h4>TCT &gt;50 Predicts Walking</h4><span class="verdict v-partial">PARTIAL</span><div class="ev-detail">Veerbeek 2011 <span class="pmid">PMID 21186329</span> EPOS: requires TCT+MI-LE combined.</div></div>
  </div>
  <div class="section-title">Measurement Plan (17)</div>
  <div class="measure-wrap" style="background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:0.5rem;">
    <table class="mtable"><thead><tr><th>Measure</th><th>Domain</th><th>Baseline</th><th>MCID</th><th>Schedule</th><th>Decision</th></tr></thead><tbody>
      <tr><td><strong>FAC</strong></td><td>Gait</td><td>2</td><td>1 level</td><td>Weekly</td><td>FAC 3&rarr;10MWT</td></tr>
      <tr><td><strong>BBS</strong></td><td>Balance</td><td>24</td><td>4-7</td><td>Wk2,4,6</td><td>Stair &ge;35</td></tr>
      <tr><td><strong>FMA-UE</strong></td><td>UL</td><td>TBD</td><td>5.25</td><td>Wk2,4,6</td><td>Recovery ratio</td></tr>
      <tr><td><strong>ARAT</strong></td><td>UL func</td><td>12/57</td><td>5.7</td><td>Wk3,6</td><td>4-wk exit</td></tr>
      <tr><td><strong>MoCA</strong></td><td>Cognition</td><td>TBD</td><td>2</td><td>Wk4,6</td><td>Attention</td></tr>
      <tr><td><strong>10MWT</strong></td><td>Speed</td><td>Assisted</td><td>0.16</td><td>Day 1+</td><td>&lt;0.10&rarr;BWSTT</td></tr>
      <tr><td><strong>PHQ-9</strong></td><td>Depression</td><td>TBD</td><td>5</td><td>Base,wk4</td><td>&ge;10 referral</td></tr>
      <tr><td><strong>FES-I</strong></td><td>Falls</td><td>TBD</td><td>8</td><td>Base,wk4</td><td>&ge;28 intervene</td></tr>
      <tr><td><strong>CSI</strong></td><td>Caregiver</td><td>TBD</td><td>&ge;7</td><td>Wk3,disch</td><td>Revise disch</td></tr>
      <tr><td><strong>MAS</strong></td><td>Spasticity</td><td>E1/W1+/A1</td><td>&mdash;</td><td>Wk2,3,4+</td><td>&ge;2&rarr;botulinum</td></tr>
    </tbody></table>
  </div>
  <div class="section-title">Consensus & Disagreements</div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
    <div><h4 style="font-family:'Syne',sans-serif;font-size:0.9rem;margin-bottom:0.5rem;">11 Consensus</h4><ul class="consensus-list"><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>180 min/day budget</li><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>FMA-UE non-negotiable</li><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>Step counts over time</li><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>b152 as mediator</li><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>Hans CSI at wk 3</li><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>Stair decision gates</li><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>MAS 2 &rarr; botulinum</li><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>MoCA replacing MMSE</li><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>d445 cap/perf split</li><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>Goal #4 reframed</li><li class="cons-item"><span class="cons-icon" style="color:var(--accept);">&#10003;</span>Wk 3 contingency</li></ul></div>
    <div><h4 style="font-family:'Syne',sans-serif;font-size:0.9rem;margin-bottom:0.5rem;">4 Disagreements</h4><ul class="consensus-list"><li class="dis-item"><span class="cons-icon" style="color:var(--partial);">&#9888;</span><strong>Recovery ratio:</strong> data-driven via FMA-UE</li><li class="dis-item"><span class="cons-icon" style="color:var(--partial);">&#9888;</span><strong>b152:</strong> mediator unless PHQ-9 &ge;10</li><li class="dis-item"><span class="cons-icon" style="color:var(--partial);">&#9888;</span><strong>Motor primacy:</strong> primary + essential adjuncts</li><li class="dis-item"><span class="cons-icon" style="color:var(--partial);">&#9888;</span><strong>Dosage:</strong> qualified by individual factors</li></ul><h4 style="font-family:'Syne',sans-serif;font-size:0.9rem;margin:1rem 0 0.5rem;">6 Biases Corrected</h4><ul class="consensus-list"><li class="cons-item"><span class="cons-icon">1</span>Motor bias &rarr; b152 + psych measures</li><li class="cons-item"><span class="cons-icon">2</span>d445 anchoring &rarr; cap/perf split</li><li class="cons-item"><span class="cons-icon">3</span>Dosage dogmatism &rarr; individualized</li><li class="cons-item"><span class="cons-icon">4</span>Confirmation bias &rarr; 5 psych measures</li><li class="cons-item"><span class="cons-icon">5</span>Impairment goal &rarr; functional assist</li><li class="cons-item"><span class="cons-icon">6</span>Evidence imprecision &rarr; qualified</li></ul></div>
  </div>
</div>

</div>

<script>
const AGENTS={
  hoac:{name:'HOAC-Coach',role:'HOAC-II Framework',color:'#4d8fff',x:450,y:72},
  icf:{name:'ICF-Mapper',role:'ICF Coding',color:'#00e88f',x:710,y:165},
  neuro:{name:'Neuro-Evidence',role:'Evidence Critique',color:'#ffd23f',x:710,y:355},
  clini:{name:'Clinimetrics',role:'Measurements',color:'#bf6dff',x:450,y:448},
  bias:{name:'Bias-Reflector',role:'Bias Detection',color:'#ff7b3a',x:190,y:355},
  lit:{name:'Literature Agent',role:'PubMed Validation',color:'#ff5ca1',x:190,y:165}
};

const CONNECTIONS=[
  {id:'icf-hoac',from:'icf',to:'hoac',items:[
    {n:1,ch:'Goal #4 is pure impairment \u2014 no d-code link. This should be rejected.',re:'Accepted. Reframing to d445 bimanual functional assist instead of impairment-level shoulder flexion goal.',st:'accepted'},
    {n:2,ch:'Missing b152 emotional functions \u2014 fear of being a burden and low self-efficacy are not coded anywhere.',re:'Accepted. Adding b152.2 as formal mediator variable with FES-I as measurement instrument.',st:'accepted'},
    {n:3,ch:'Hans needs dual-coding as e310: facilitator +3 AND barrier -1. His back problems make him a risk factor too.',re:'Accepted. Elevating Hans to testable hypothesis with week 3 gate: CSI \u22657 OR cannot demonstrate standby assist \u2192 revise discharge.',st:'accepted'},
  ]},
  {id:'neuro-hoac',from:'neuro',to:'hoac',items:[
    {n:4,ch:'Intensity gap is critical: your plan totals 110-140 min/day vs the 180 min guideline. This is sub-therapeutic.',re:'Accepted. Revising total therapy budget to 180 min/day minimum. Redistributing across all domains.',st:'accepted'},
    {n:5,ch:'Time-based gait dosing is outdated. We need step counts: 1000-2000 steps/session with progressive targets.',re:'Accepted. Adding 500\u21922000 progressive step-count targets. Starting conservative given FAC 2.',st:'accepted'},
  ]},
  {id:'neuro-icf',from:'neuro',to:'icf',items:[
    {n:6,ch:'Your d445 coding needs a capacity vs performance distinction. What can she do vs what does she do?',re:'Good point. Creating d445 capacity .3 / performance .4 split. This is an important distinction that resolves the anchoring concern too.',st:'accepted'},
  ]},
  {id:'clini-hoac',from:'clini',to:'hoac',items:[
    {n:7,ch:'FMA-UE is NON-NEGOTIABLE. ARAT subscores alone cannot track synergy stage progression. Add it from baseline.',re:'Accepted. Adding FMA-UE from baseline assessment. Will use for recovery/compensation ratio decisions.',st:'accepted'},
  ]},
  {id:'clini-neuro',from:'clini',to:'neuro',items:[
    {n:8,ch:'FAC alone is insufficient for gait assessment. You need a multi-level measurement framework with MCIDs for each.',re:'Accepted. Incorporating the expanded measurement framework. FAC as screening, 10MWT/6MWT/BBS as detailed outcome tracking.',st:'accepted'},
  ]},
  {id:'bias-hoac',from:'bias',to:'hoac',broadcast:true,items:[
    {n:9,ch:'MOTOR BIAS DETECTED across all agents. All 4 problems are motor-framed. Where are the psychological mediators? Fear, self-efficacy, attention \u2014 these may be driving limitations more than weakness.',re:'ALL agents respond: Adding psychological mediators (b152, FES-I, PHQ-9, SSEQ) across the plan. Bias-Reflector is right \u2014 this was a collective blind spot.',st:'accepted'},
  ]},
  {id:'bias-neuro',from:'bias',to:'neuro',items:[
    {n:10,ch:'"Dosage dogmatism" \u2014 your 180 min and rep counts assume a standard patient. Maria has MMSE 25, atrial fibrillation, and is 68. Intensity must be individualized.',re:'Partially accepted. The evidence base supports high intensity, but will qualify: session blocks of 15-20 min for attention, RPE-guided for cardiovascular, with individual titration.',st:'partial'},
  ]},
  {id:'bias-clini',from:'bias',to:'clini',items:[
    {n:11,ch:'Confirmation bias in test selection \u2014 all your measures are motor-focused. You\u2019re measuring what you expect to find.',re:'Accepted. Adding PHQ-9 (depression), FES-I (falls efficacy), SSEQ (self-efficacy), TMT-A/B (attention), and CSI (caregiver strain). Five psychological/cognitive measures.',st:'accepted'},
  ]},
  {id:'bias-icf',from:'bias',to:'icf',items:[
    {n:12,ch:'Your d445 qualifier of .4 (complete problem) creates anchoring bias. Clinicians may read it as "no point treating the arm."',re:'Creating capacity .3 / performance .4 split. This shows the arm HAS capacity (.3 = severe but not complete) while performance is worse (.4). Resolves the anchoring.',st:'accepted'},
  ]},
];

// Flatten for replay
const FLAT=[];
CONNECTIONS.forEach(c=>c.items.forEach(item=>FLAT.push({...item,connId:c.id,from:c.from,to:c.to,broadcast:c.broadcast})));
FLAT.sort((a,b)=>a.n-b.n);

// Path elements map
const pathEls={};
let activeConn=null;
const R=36;
let speedMultiplier=1;

function showPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  event.currentTarget.classList.add('active');
}
function setSpeed(s){
  speedMultiplier=s;
  document.querySelectorAll('.speed-btn').forEach(b=>{b.classList.toggle('active',parseFloat(b.dataset.speed)===s);});
}

function init(){
  const connG=document.getElementById('connections');
  const badgeG=document.getElementById('countBadges');
  const nodeG=document.getElementById('agentNodes');

  CONNECTIONS.forEach((conn,idx)=>{
    const from=AGENTS[conn.from],to=AGENTS[conn.to],count=conn.items.length;
    const mx=(from.x+to.x)/2,my=(from.y+to.y)/2;
    const dx=to.x-from.x,dy=to.y-from.y,len=Math.sqrt(dx*dx+dy*dy);
    const nx=-dy/len,ny=dx/len;
    const off=30+(idx%3)*12,side=idx%2===0?1:-1;
    const cx=mx+nx*off*side,cy=my+ny*off*side;
    const sa=Math.atan2(cy-from.y,cx-from.x),ea=Math.atan2(cy-to.y,cx-to.x);
    const sx=from.x+Math.cos(sa)*(R+4),sy=from.y+Math.sin(sa)*(R+4);
    const ex=to.x+Math.cos(ea)*(R+8),ey=to.y+Math.sin(ea)*(R+8);
    const d=`M${sx},${sy} Q${cx},${cy} ${ex},${ey}`;

    const hit=svgEl('path',{d,fill:'none',stroke:'transparent','stroke-width':18,cursor:'pointer'});
    hit.addEventListener('click',()=>toggleInteraction(conn));
    hit.addEventListener('mouseenter',()=>{if(activeConn!==conn.id)highlightConn(conn.id,true);});
    hit.addEventListener('mouseleave',()=>{if(activeConn!==conn.id)highlightConn(conn.id,false);});
    connG.appendChild(hit);

    const path=svgEl('path',{d,class:'conn-path',stroke:from.color,'stroke-width':Math.max(1.5,count*1.2),'marker-end':`url(#arrow-${conn.from})`,'data-conn':conn.id});
    if(conn.broadcast){path.setAttribute('stroke-dasharray','6 4');path.style.opacity='0.3';}
    connG.appendChild(path);
    pathEls[conn.id]=path;

    const bx=(sx+2*cx+ex)/4,by=(sy+2*cy+ey)/4;
    if(count>1){
      badgeG.appendChild(svgEl('circle',{cx:bx,cy:by,r:9,fill:from.color,class:'conn-count-bg','data-conn':conn.id}));
      const t=svgEl('text',{x:bx,y:by+3.5,class:'conn-count','data-conn':conn.id});t.textContent=count;badgeG.appendChild(t);
    }
  });

  Object.entries(AGENTS).forEach(([id,a])=>{
    const g=svgEl('g',{class:'agent-node','data-agent':id});
    const glow=svgEl('circle',{cx:a.x,cy:a.y,r:R+12,fill:a.color,opacity:0.15,class:'agent-glow'});
    glow.style.animationDelay=Math.random()*3+'s';g.appendChild(glow);
    g.appendChild(svgEl('circle',{cx:a.x,cy:a.y,r:R,fill:'#0c1020',stroke:a.color,'stroke-width':2}));
    g.appendChild(svgEl('circle',{cx:a.x,cy:a.y,r:R-6,fill:'none',stroke:a.color,'stroke-width':0.5,opacity:0.3}));
    const nm=svgEl('text',{x:a.x,y:a.y+1,class:'node-label'});
    nm.textContent={hoac:'HOAC',icf:'ICF',neuro:'NEURO',clini:'CLINI',bias:'BIAS',lit:'LIT'}[id];g.appendChild(nm);
    const rl=svgEl('text',{x:a.x,y:a.y+R+16,class:'node-role'});rl.textContent=a.role;g.appendChild(rl);
    const fn=svgEl('text',{x:a.x,y:a.y-R-8,class:'node-role',fill:a.color,'font-weight':'600'});fn.textContent=a.name;g.appendChild(fn);
    nodeG.appendChild(g);
  });

  buildTimeline();
}

function svgEl(tag,attrs){
  const el=document.createElementNS('http://www.w3.org/2000/svg',tag);
  Object.entries(attrs||{}).forEach(([k,v])=>el.setAttribute(k,v));return el;
}

function highlightConn(id,on){
  document.querySelectorAll(`.conn-path[data-conn="${id}"]`).forEach(el=>{
    if(on){el.classList.add('active','animated');}else{el.classList.remove('active','animated');}
  });
}

function setAgentState(agentId,state){
  const node=document.querySelector(`[data-agent="${agentId}"]`);
  if(!node)return;
  node.classList.remove('speaking','challenged','responding','dimmed','active-agent');
  if(state)node.classList.add(state);
}
function dimAllAgents(){Object.keys(AGENTS).forEach(id=>setAgentState(id,'dimmed'));}
function resetAllAgents(){Object.keys(AGENTS).forEach(id=>setAgentState(id,null));}

// Data pulse animation
function sendPulse(connId,color,duration,reverse){
  const path=pathEls[connId];if(!path)return Promise.resolve();
  const layer=document.getElementById('pulseLayer');
  const totalLen=path.getTotalLength();
  return new Promise(resolve=>{
    const c=svgEl('circle',{r:5,fill:color,class:'data-pulse',filter:'url(#glow)'});
    const trail=svgEl('circle',{r:3,fill:color,opacity:0.4});
    layer.appendChild(trail);layer.appendChild(c);
    const start=performance.now();
    function tick(now){
      let p=(now-start)/duration;
      if(p>=1){c.remove();trail.remove();resolve();return;}
      if(reverse)p=1-p;
      const pt=path.getPointAtLength(p*totalLen);
      c.setAttribute('cx',pt.x);c.setAttribute('cy',pt.y);
      const tp=path.getPointAtLength(Math.max(0,(p-0.08))*totalLen);
      trail.setAttribute('cx',tp.x);trail.setAttribute('cy',tp.y);
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  });
}

// Chat transcript
function clearChat(){
  document.getElementById('chatBody').innerHTML='<div class="chat-empty"><p>&#128172;</p><p>Click a connection or hit Replay<br>to watch the debate unfold</p></div>';
}
function addChatDivider(text){
  const body=document.getElementById('chatBody');
  const empty=body.querySelector('.chat-empty');if(empty)empty.remove();
  const div=document.createElement('div');div.className='chat-divider';div.textContent=text;
  body.appendChild(div);body.scrollTop=body.scrollHeight;
}
function addChatMessage(agentId,targetId,text,type,status){
  const body=document.getElementById('chatBody');
  const empty=body.querySelector('.chat-empty');if(empty)empty.remove();
  const a=AGENTS[agentId];
  const msg=document.createElement('div');msg.className='chat-msg';
  let hdr=`<div class="chat-msg-header"><div class="chat-dot" style="background:${a.color}"></div><span class="chat-agent" style="color:${a.color}">${a.name}</span>`;
  if(targetId){
    const t=AGENTS[targetId];
    hdr+=`<span class="chat-arrow">\u2192</span><span class="chat-target" style="color:${t?t.color:'#fff'}">${t?t.name:'ALL AGENTS'}</span>`;
  }
  hdr+=`</div>`;
  const bubbleClass=type==='challenge'?'challenge':'response';
  const borderColor=type==='challenge'?a.color:'var(--accept)';
  let statusHtml='';
  if(status){
    const sc=status==='accepted'?'s-accepted':status==='partial'?'s-partial':'s-rejected';
    const sl=status==='accepted'?'ACCEPTED':status==='partial'?'PARTIALLY ACCEPTED':'REJECTED';
    statusHtml=`<div><span class="chat-status ${sc}">${sl}</span></div>`;
  }
  msg.innerHTML=hdr+`<div class="chat-bubble ${bubbleClass}" style="border-left-color:${borderColor}">${text}${statusHtml}</div>`;
  body.appendChild(msg);
  body.scrollTop=body.scrollHeight;
}

// Timeline
function buildTimeline(){
  const dots=document.getElementById('tlDots');
  FLAT.forEach((item,i)=>{
    const dot=document.createElement('div');
    dot.className='tl-dot';dot.dataset.idx=i;dot.textContent=item.n;
    dot.innerHTML+=`<div class="tl-tooltip">${AGENTS[item.from].name} \u2192 ${item.to?AGENTS[item.to].name:'ALL'}</div>`;
    dot.addEventListener('click',()=>jumpToInteraction(i));
    dots.appendChild(dot);
  });
}
function updateTimeline(idx){
  const dots=document.querySelectorAll('.tl-dot');
  dots.forEach((d,i)=>{d.classList.remove('current','visited');if(i<idx)d.classList.add('visited');if(i===idx)d.classList.add('current');});
  const pct=((idx+1)/FLAT.length)*100;
  document.getElementById('tlProgress').style.width=pct+'%';
  const item=FLAT[idx];
  document.getElementById('tlLabel').textContent=`Interaction ${idx+1}/${FLAT.length}: ${AGENTS[item.from].name} \u2192 ${item.to?AGENTS[item.to].name:'ALL'}`;
}
function jumpToInteraction(idx){
  if(replaying)stopReplay();
  resetAllAgents();CONNECTIONS.forEach(c=>highlightConn(c.id,false));
  clearChat();
  // Show all messages up to idx
  for(let i=0;i<=idx;i++){
    const item=FLAT[i];
    addChatMessage(item.from,item.to,item.ch,'challenge');
    addChatMessage(item.to||item.from,null,item.re,'response',item.st);
  }
  const item=FLAT[idx];
  highlightConn(item.connId,true);
  activeConn=item.connId;
  setAgentState(item.from,'speaking');
  if(item.to)setAgentState(item.to,'responding');
  updateTimeline(idx);
}

// Replay system
let replaying=false,replayTimer=null,replayIdx=-1;
function replayDebate(){
  if(replaying){stopReplay();return;}
  replaying=true;replayIdx=-1;
  const btn=document.getElementById('replayBtn');
  btn.classList.add('playing');btn.innerHTML='&#9632; Stop';
  document.getElementById('liveDot').classList.add('on');
  clearChat();dimAllAgents();
  CONNECTIONS.forEach(c=>highlightConn(c.id,false));
  activeConn=null;
  addChatDivider('ROUND 1 \u2014 Opening Challenges');
  nextReplayStep();
}
function stopReplay(){
  replaying=false;clearTimeout(replayTimer);
  const btn=document.getElementById('replayBtn');
  btn.classList.remove('playing');btn.innerHTML='&#9654; Replay Debate';
  document.getElementById('liveDot').classList.remove('on');
  resetAllAgents();
}
async function nextReplayStep(){
  if(!replaying)return;
  // Clean up previous
  if(replayIdx>=0){
    const prev=FLAT[replayIdx];
    highlightConn(prev.connId,false);
    setAgentState(prev.from,'dimmed');
    if(prev.to)setAgentState(prev.to,'dimmed');
  }
  replayIdx++;
  if(replayIdx>=FLAT.length){
    addChatDivider('DEBATE COMPLETE \u2014 11 consensus, 4 productive disagreements');
    stopReplay();resetAllAgents();return;
  }
  // Round divider
  if(replayIdx===9)addChatDivider('ROUND 2 \u2014 Responses & New Findings');

  const item=FLAT[replayIdx];
  const from=AGENTS[item.from],to=item.to?AGENTS[item.to]:null;

  // 1. Source speaks
  setAgentState(item.from,'speaking');
  highlightConn(item.connId,true);
  activeConn=item.connId;
  updateTimeline(replayIdx);

  // 2. Challenge message
  addChatMessage(item.from,item.to,item.ch,'challenge');

  // 3. Data pulse travels
  const dur=800/speedMultiplier;
  await sendPulse(item.connId,from.color,dur,false);
  if(!replaying)return;

  // 4. Target reacts
  if(item.to)setAgentState(item.to,'challenged');
  await sleep(300/speedMultiplier);
  if(!replaying)return;
  if(item.to)setAgentState(item.to,'responding');

  // 5. Response pulse back
  await sendPulse(item.connId,to?to.color:'#fff',dur,true);
  if(!replaying)return;

  // 6. Response message
  addChatMessage(item.to||item.from,null,item.re,'response',item.st);
  await sleep(600/speedMultiplier);
  if(!replaying)return;

  // 7. Schedule next
  replayTimer=setTimeout(()=>nextReplayStep(),400/speedMultiplier);
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// Click interaction panel (non-replay)
function toggleInteraction(conn){
  const panel=document.getElementById('interactionPanel');
  if(activeConn===conn.id){panel.classList.remove('open');highlightConn(conn.id,false);activeConn=null;return;}
  if(activeConn)highlightConn(activeConn,false);
  activeConn=conn.id;highlightConn(conn.id,true);
  const from=AGENTS[conn.from],to=conn.broadcast?null:AGENTS[conn.to];
  let html=`<div class="interaction-panel-header"><span style="color:${from.color};font-weight:700;">${from.name}</span><span style="font-size:1.2rem;color:var(--text-dim);">\u2192</span><span style="color:${to?to.color:'#fff'};font-weight:700;">${to?to.name:'ALL AGENTS'}</span><span style="margin-left:0.5rem;font-size:0.75rem;color:var(--text-dim);">${conn.items.length} interaction${conn.items.length>1?'s':''}</span><button class="close-panel" onclick="toggleInteraction({id:'${conn.id}'})">&times;</button></div><div class="interaction-list">`;
  conn.items.forEach(item=>{
    const sc=item.st==='accepted'?'status-accepted':item.st==='partial'?'status-partial':'status-rejected';
    const sl=item.st==='accepted'?'ACCEPTED':item.st==='partial'?'PARTIAL':'REJECTED';
    html+=`<div class="interaction-item"><div class="int-num">#${item.n}</div><div class="int-challenge">${item.ch}</div><div class="int-arrow">\u2192</div><div class="int-response">${item.re}<br><span class="int-status ${sc}">${sl}</span></div></div>`;
  });
  panel.innerHTML=html+'</div>';
  panel.classList.add('open');
  // Also show in chat
  const chatBody=document.getElementById('chatBody');
  const empty=chatBody.querySelector('.chat-empty');if(empty)empty.remove();
  conn.items.forEach(item=>{
    addChatMessage(conn.from,conn.to,item.ch,'challenge');
    addChatMessage(conn.to||conn.from,null,item.re,'response',item.st);
  });
}

document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
